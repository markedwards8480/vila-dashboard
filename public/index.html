<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Villa 8 | Amanyara Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { 
      --primary: #1a3a4a; 
      --primary-light: #2d5a6e; 
      --accent: #c9a962; 
      --text: #1a1a1a; 
      --text-light: #666; 
      --card-bg: rgba(255,255,255,0.92); 
      --shadow: 0 8px 32px rgba(0,0,0,0.1);
      --owner-color: #2d5a6e;
      --guest-color: #c9a962;
      --rental-color: #4a9e6e;
      --vacant-color: #bbb;
    }
    body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #e8e4dc 0%, #d4cfc4 50%, #c9c4b8 100%); min-height: 100vh; color: var(--text); }
    h1,h2,h3 { font-family: 'Cormorant Garamond', serif; font-weight: 400; }
    
    .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .login-card { background: var(--card-bg); border-radius: 24px; padding: 3rem; width: 100%; max-width: 420px; box-shadow: var(--shadow); }
    .login-logo { text-align: center; margin-bottom: 2rem; }
    .login-logo h1 { font-size: 2.5rem; color: var(--primary); }
    .login-logo span { font-size: 0.85rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.3em; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-light); margin-bottom: 0.5rem; }
    .form-group input, .form-group select { width: 100%; padding: 1rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-family: inherit; font-size: 1rem; background: white; }
    .btn { padding: 1rem 2rem; border: none; border-radius: 12px; font-family: inherit; font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.15em; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }
    .btn-primary:hover { background: var(--primary-light); }
    .error-message { background: #fee; color: #c00; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
    
    .dashboard { display: none; min-height: 100vh; }
    .dashboard.active { display: block; }
    .login-container.hidden { display: none; }
    
    .header { background: var(--card-bg); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
    .header-brand { display: flex; align-items: center; gap: 1rem; }
    .header-brand h1 { font-size: 1.5rem; color: var(--primary); }
    .header-brand span { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.2em; background: rgba(201,169,98,0.15); padding: 0.35rem 0.75rem; border-radius: 4px; }
    .header-btn { padding: 0.5rem 1rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; background: transparent; font-family: inherit; font-size: 0.8rem; cursor: pointer; }
    .header-btn:hover { background: var(--primary); color: white; }
    
    .main-content { padding: 2rem; max-width: 1800px; margin: 0 auto; }
    
    .view-selector { background: var(--card-bg); border-radius: 16px; padding: 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: flex-start; gap: 1.5rem; box-shadow: var(--shadow); flex-wrap: wrap; }
    .view-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .view-group label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-light); }
    .view-group select { padding: 0.6rem 1rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: inherit; background: white; min-width: 180px; }
    .view-group select[multiple] { height: 120px; }
    .view-info { font-size: 0.85rem; color: var(--text-light); margin-left: auto; align-self: center; }
    
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--card-bg); border-radius: 12px; padding: 0.5rem; box-shadow: var(--shadow); flex-wrap: wrap; }
    .tab-btn { padding: 0.75rem 1.25rem; border: none; border-radius: 8px; font-family: inherit; font-size: 0.8rem; font-weight: 500; color: var(--text-light); background: transparent; cursor: pointer; }
    .tab-btn:hover { color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .kpi-card { background: var(--card-bg); border-radius: 16px; padding: 1.25rem; box-shadow: var(--shadow); }
    .kpi-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); margin-bottom: 0.4rem; }
    .kpi-value { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 500; color: var(--primary); }
    .kpi-value.accent { color: var(--accent); }
    .kpi-value.owner { color: var(--owner-color); }
    .kpi-value.guest { color: var(--guest-color); }
    .kpi-value.rental { color: var(--rental-color); }
    .kpi-value.vacant { color: var(--vacant-color); }
    .kpi-sub { font-size: 0.7rem; color: var(--text-light); margin-top: 0.25rem; }
    
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .chart-card { background: var(--card-bg); border-radius: 16px; padding: 1.25rem; box-shadow: var(--shadow); }
    .chart-card h3 { font-size: 1rem; color: var(--primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .chart-container { position: relative; height: 260px; }
    
    .occupancy-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .occ-card { background: var(--card-bg); border-radius: 12px; padding: 1.25rem; box-shadow: var(--shadow); text-align: center; border-left: 4px solid; }
    .occ-card.owner { border-color: var(--owner-color); }
    .occ-card.guest { border-color: var(--guest-color); }
    .occ-card.rental { border-color: var(--rental-color); }
    .occ-card.vacant { border-color: var(--vacant-color); }
    .occ-value { font-family: 'Cormorant Garamond', serif; font-size: 2.25rem; font-weight: 600; }
    .occ-card.owner .occ-value { color: var(--owner-color); }
    .occ-card.guest .occ-value { color: var(--guest-color); }
    .occ-card.rental .occ-value { color: var(--rental-color); }
    .occ-card.vacant .occ-value { color: var(--vacant-color); }
    .occ-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); margin-top: 0.4rem; }
    .occ-pct { font-size: 0.85rem; color: var(--text-light); margin-top: 0.2rem; font-weight: 500; }
    
    .section-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
    .section-card h3 { font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); }
    
    .expense-table { width: 100%; border-collapse: collapse; }
    .expense-table th { text-align: left; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-light); padding: 0.75rem 0.5rem; border-bottom: 2px solid rgba(0,0,0,0.1); }
    .expense-table th.num { text-align: right; }
    .expense-table td { padding: 0.6rem 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; }
    .expense-table td.num { text-align: right; font-variant-numeric: tabular-nums; }
    .expense-table tr.category-row { background: rgba(0,0,0,0.02); }
    .expense-table tr.category-row td { font-weight: 600; padding: 0.75rem 0.5rem; }
    .expense-table tr.category-row td:first-child { color: var(--primary); }
    .expense-table tr.item-row td:first-child { padding-left: 1.5rem; color: var(--text-light); }
    .expense-table tr.total-row { background: var(--primary); color: white; }
    .expense-table tr.total-row td { padding: 0.85rem 0.5rem; font-weight: 600; }
    
    .pct-bar { display: inline-block; height: 8px; background: var(--accent); border-radius: 4px; margin-right: 0.5rem; vertical-align: middle; }
    .pct-text { font-size: 0.75rem; color: var(--text-light); }
    
    .heatmap-container { overflow-x: auto; }
    .heatmap { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .heatmap th, .heatmap td { padding: 0.5rem; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
    .heatmap th { background: var(--primary); color: white; font-size: 0.7rem; font-weight: 500; }
    .heatmap th:first-child { text-align: left; }
    .heatmap td:first-child { text-align: left; font-weight: 500; background: rgba(0,0,0,0.02); }
    .heatmap .heat-0 { background: #f5f5f5; }
    .heatmap .heat-1 { background: #fff3cd; }
    .heatmap .heat-2 { background: #ffe69c; }
    .heatmap .heat-3 { background: #ffda6a; }
    .heatmap .heat-4 { background: #ffcd39; }
    .heatmap .heat-5 { background: #ffc107; color: #000; }
    
    .month-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .month-table th, .month-table td { padding: 0.6rem 0.75rem; text-align: right; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .month-table th { background: var(--primary); color: white; font-size: 0.7rem; font-weight: 500; text-transform: uppercase; }
    .month-table th:first-child, .month-table td:first-child { text-align: left; }
    .month-table tr.total-row { background: rgba(0,0,0,0.03); font-weight: 600; }
    
    .upload-section { max-width: 600px; }
    .upload-zone { border: 2px dashed rgba(0,0,0,0.15); border-radius: 16px; padding: 3rem; text-align: center; cursor: pointer; }
    .upload-zone:hover { border-color: var(--accent); background: rgba(201,169,98,0.05); }
    .upload-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .upload-text { color: var(--text-light); }
    .upload-text strong { color: var(--accent); }
    .file-input { display: none; }
    .upload-status { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; }
    .upload-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
    .upload-status.error { display: block; background: #ffebee; color: #c62828; }
    .upload-status.loading { display: block; background: #e3f2fd; color: #1565c0; }
    
    .file-list { max-height: 200px; overflow-y: auto; margin-top: 1rem; }
    .file-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; }
    
    @media (max-width: 1000px) { .occupancy-grid { grid-template-columns: repeat(2, 1fr); } .charts-grid { grid-template-columns: 1fr; } }
    @media (max-width: 600px) { .occupancy-grid { grid-template-columns: 1fr 1fr; } .kpi-grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <div class="login-logo">
        <h1>Villa 8</h1>
        <span>Amanyara</span>
      </div>
      <div class="error-message" id="loginError"></div>
      <form id="loginForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" class="btn btn-primary">Sign In</button>
      </form>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <header class="header">
      <div class="header-brand">
        <h1>Villa 8</h1>
        <span>Amanyara</span>
      </div>
      <div>
        <span id="welcomeUser" style="margin-right:1rem;font-size:0.85rem;"></span>
        <button class="header-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <main class="main-content">
      <div class="view-selector">
        <div class="view-group">
          <label>View Mode</label>
          <select id="viewMode" onchange="changeViewMode()">
            <option value="single">Individual Months</option>
            <option value="rolling12">Rolling 12 Months</option>
          </select>
        </div>
        <div class="view-group" id="monthGroup">
          <label>Select Month(s) - Ctrl/Cmd+Click for multiple</label>
          <select id="monthSelect" multiple onchange="loadSelectedMonths()">
          </select>
        </div>
        <div class="view-group" id="yearGroup" style="display:none;">
          <label>Year</label>
          <select id="yearSelect" onchange="loadYearData()">
          </select>
        </div>
        <span class="view-info" id="viewInfo"></span>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="occupancy">Occupancy</button>
        <button class="tab-btn" data-tab="expenses">Expenses</button>
        <button class="tab-btn" data-tab="heatmap">Heat Map</button>
        <button class="tab-btn" data-tab="upload">Upload</button>
      </div>

      <div class="tab-content active" id="tab-overview">
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Current Balance</div>
            <div class="kpi-value" id="kpiBalance">--</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Expenses</div>
            <div class="kpi-value accent" id="kpiExpenses">--</div>
            <div class="kpi-sub" id="kpiExpensesPct"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Owner Nights</div>
            <div class="kpi-value owner" id="kpiOwnerNights">--</div>
            <div class="kpi-sub" id="kpiOwnerPct"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Guest Nights</div>
            <div class="kpi-value guest" id="kpiGuestNights">--</div>
            <div class="kpi-sub" id="kpiGuestPct"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Rental Nights</div>
            <div class="kpi-value rental" id="kpiRentalNights">--</div>
            <div class="kpi-sub" id="kpiRentalPct"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Vacant Nights</div>
            <div class="kpi-value vacant" id="kpiVacantNights">--</div>
            <div class="kpi-sub" id="kpiVacantPct"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Owner Revenue (50%)</div>
            <div class="kpi-value accent" id="kpiRevenue">--</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Nights</div>
            <div class="kpi-value" id="kpiTotalNights">--</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-card">
            <h3>Expense Trend</h3>
            <div class="chart-container"><canvas id="expenseChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>Occupancy Mix</h3>
            <div class="chart-container"><canvas id="occupancyChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-occupancy">
        <div class="occupancy-grid">
          <div class="occ-card owner">
            <div class="occ-value" id="occOwner">--</div>
            <div class="occ-label">Owner Nights</div>
            <div class="occ-pct" id="occOwnerPct">--</div>
          </div>
          <div class="occ-card guest">
            <div class="occ-value" id="occGuest">--</div>
            <div class="occ-label">Guest Nights</div>
            <div class="occ-pct" id="occGuestPct">--</div>
          </div>
          <div class="occ-card rental">
            <div class="occ-value" id="occRental">--</div>
            <div class="occ-label">Rental Nights</div>
            <div class="occ-pct" id="occRentalPct">--</div>
          </div>
          <div class="occ-card vacant">
            <div class="occ-value" id="occVacant">--</div>
            <div class="occ-label">Vacant Nights</div>
            <div class="occ-pct" id="occVacantPct">--</div>
          </div>
        </div>

        <div class="section-card">
          <h3>Monthly Breakdown</h3>
          <div id="occupancyTableContainer"></div>
        </div>

        <div class="chart-card">
          <h3>Occupancy Over Time</h3>
          <div class="chart-container" style="height:300px;"><canvas id="occupancyBarChart"></canvas></div>
        </div>
      </div>

      <div class="tab-content" id="tab-expenses">
        <div class="section-card">
          <h3>Expense Breakdown</h3>
          <div id="expenseTableContainer"></div>
        </div>
        
        <div class="charts-grid">
          <div class="chart-card">
            <h3>By Category</h3>
            <div class="chart-container"><canvas id="expensePieChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>Top Cost Drivers</h3>
            <div class="chart-container"><canvas id="expenseBarChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-heatmap">
        <div class="section-card">
          <h3>Expense Heat Map by Month</h3>
          <div class="heatmap-container" id="heatmapContainer"></div>
        </div>
      </div>

      <div class="tab-content" id="tab-upload">
        <div class="section-card upload-section">
          <h3>Upload Statement</h3>
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">ðŸ“„</div>
            <p class="upload-text"><strong>Click to upload</strong> or drag & drop</p>
            <p class="upload-text">Amanyara Monthly Statement PDF</p>
          </div>
          <input type="file" id="fileInput" class="file-input" accept=".pdf">
          <div class="upload-status" id="uploadStatus"></div>
          <div class="file-list" id="fileList"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentUser = null;
    let dashboardData = null;
    let allStatements = [];
    let availableYears = [];
    let charts = {};

    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/status');
        const data = await res.json();
        if (data.authenticated) {
          currentUser = data.username;
          showDashboard();
        }
      } catch (err) {}
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorEl = document.getElementById('loginError');
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
          currentUser = data.username;
          showDashboard();
        } else {
          errorEl.textContent = data.error || 'Login failed';
          errorEl.style.display = 'block';
        }
      } catch (err) {
        errorEl.textContent = 'Connection error';
        errorEl.style.display = 'block';
      }
    });

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      currentUser = null;
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('active');
    }

    async function showDashboard() {
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('welcomeUser').textContent = `Welcome, ${currentUser}`;
      await loadInitialData();
    }

    async function loadInitialData() {
      try {
        const res = await fetch('/api/statements');
        const data = await res.json();
        allStatements = data.statements || [];
        availableYears = data.availableYears || [];
        populateSelectors();
        if (allStatements.length > 0) {
          document.getElementById('monthSelect').options[0].selected = true;
          await loadSelectedMonths();
        }
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    function populateSelectors() {
      const monthSelect = document.getElementById('monthSelect');
      const yearSelect = document.getElementById('yearSelect');
      const viewMode = document.getElementById('viewMode');
      
      viewMode.innerHTML = `
        <option value="single">Individual Months</option>
        ${availableYears.map(y => `<option value="year-${y}">Calendar Year ${y}</option>`).join('')}
        <option value="rolling12">Rolling 12 Months</option>
      `;
      
      const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      monthSelect.innerHTML = allStatements.map(s => 
        `<option value="${s.id}">${months[s.month]} ${s.year}</option>`
      ).join('');
      
      yearSelect.innerHTML = availableYears.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function changeViewMode() {
      const mode = document.getElementById('viewMode').value;
      const monthGroup = document.getElementById('monthGroup');
      const yearGroup = document.getElementById('yearGroup');
      
      if (mode === 'single') {
        monthGroup.style.display = 'block';
        yearGroup.style.display = 'none';
        loadSelectedMonths();
      } else if (mode === 'rolling12') {
        monthGroup.style.display = 'none';
        yearGroup.style.display = 'none';
        loadRolling12();
      } else if (mode.startsWith('year-')) {
        monthGroup.style.display = 'none';
        yearGroup.style.display = 'none';
        loadYearData(mode.split('-')[1]);
      }
    }

    async function loadSelectedMonths() {
      const select = document.getElementById('monthSelect');
      const selectedIds = Array.from(select.selectedOptions).map(o => o.value);
      if (selectedIds.length === 0) return;
      
      try {
        const res = await fetch(`/api/dashboard?ids=${selectedIds.join(',')}`);
        dashboardData = await res.json();
        document.getElementById('viewInfo').textContent = `${dashboardData.statements.length} month(s) selected`;
        updateDisplay();
      } catch (err) {
        console.error('Failed to load months:', err);
      }
    }

    async function loadYearData(year) {
      if (!year) year = document.getElementById('yearSelect').value;
      try {
        const res = await fetch(`/api/dashboard?year=${year}`);
        dashboardData = await res.json();
        document.getElementById('viewInfo').textContent = `Calendar Year ${year} (${dashboardData.statements.length} months)`;
        updateDisplay();
      } catch (err) {
        console.error('Failed to load year:', err);
      }
    }

    async function loadRolling12() {
      try {
        const res = await fetch('/api/dashboard?rolling=12');
        dashboardData = await res.json();
        document.getElementById('viewInfo').textContent = `Rolling 12 Months (${dashboardData.statements.length} months)`;
        updateDisplay();
      } catch (err) {
        console.error('Failed to load rolling 12:', err);
      }
    }

    function updateDisplay() {
      const t = dashboardData.totals || {};
      const statements = dashboardData.statements || [];
      
      document.getElementById('kpiBalance').textContent = formatCurrency(t.totalBalance);
      document.getElementById('kpiExpenses').textContent = formatCurrency(t.totalExpenses);
      document.getElementById('kpiOwnerNights').textContent = t.totalOwnerNights || 0;
      document.getElementById('kpiGuestNights').textContent = t.totalGuestNights || 0;
      document.getElementById('kpiRentalNights').textContent = t.totalRentalNights || 0;
      document.getElementById('kpiVacantNights').textContent = t.totalVacantNights || 0;
      document.getElementById('kpiRevenue').textContent = formatCurrency(t.totalRevenue);
      
      const totalNights = (t.totalOwnerNights||0) + (t.totalGuestNights||0) + (t.totalRentalNights||0) + (t.totalVacantNights||0);
      document.getElementById('kpiTotalNights').textContent = totalNights;
      
      if (totalNights > 0) {
        document.getElementById('kpiOwnerPct').textContent = `${((t.totalOwnerNights/totalNights)*100).toFixed(1)}% of nights`;
        document.getElementById('kpiGuestPct').textContent = `${((t.totalGuestNights/totalNights)*100).toFixed(1)}% of nights`;
        document.getElementById('kpiRentalPct').textContent = `${((t.totalRentalNights/totalNights)*100).toFixed(1)}% of nights`;
        document.getElementById('kpiVacantPct').textContent = `${((t.totalVacantNights/totalNights)*100).toFixed(1)}% of nights`;
      }
      
      if (t.totalRevenue > 0) {
        const expPct = ((t.totalExpenses / t.totalRevenue) * 100).toFixed(1);
        document.getElementById('kpiExpensesPct').textContent = `${expPct}% of revenue`;
      }
      
      // Occupancy tab
      document.getElementById('occOwner').textContent = t.totalOwnerNights || 0;
      document.getElementById('occGuest').textContent = t.totalGuestNights || 0;
      document.getElementById('occRental').textContent = t.totalRentalNights || 0;
      document.getElementById('occVacant').textContent = t.totalVacantNights || 0;
      if (totalNights > 0) {
        document.getElementById('occOwnerPct').textContent = `${((t.totalOwnerNights/totalNights)*100).toFixed(1)}%`;
        document.getElementById('occGuestPct').textContent = `${((t.totalGuestNights/totalNights)*100).toFixed(1)}%`;
        document.getElementById('occRentalPct').textContent = `${((t.totalRentalNights/totalNights)*100).toFixed(1)}%`;
        document.getElementById('occVacantPct').textContent = `${((t.totalVacantNights/totalNights)*100).toFixed(1)}%`;
      }
      
      updateCharts();
      updateExpenseTable();
      updateOccupancyTable();
      updateHeatmap();
      updateRecentFiles();
    }

    function updateExpenseTable() {
      const categories = dashboardData.expensesByCategory || [];
      const container = document.getElementById('expenseTableContainer');
      
      if (categories.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light);">No expense data</p>';
        return;
      }
      
      let grandTotal = categories.reduce((sum, c) => sum + c.total, 0);
      
      let html = `<table class="expense-table">
        <thead><tr>
          <th>Category / Item</th>
          <th class="num">Amount</th>
          <th class="num">% of Total</th>
          <th>Distribution</th>
        </tr></thead><tbody>`;
      
      for (const cat of categories) {
        html += `<tr class="category-row">
          <td>${cat.category}</td>
          <td class="num">${formatCurrency(cat.total)}</td>
          <td class="num">${cat.pctOfTotal.toFixed(1)}%</td>
          <td><span class="pct-bar" style="width:${cat.pctOfTotal}%;"></span></td>
        </tr>`;
        for (const item of cat.items) {
          html += `<tr class="item-row">
            <td>${item.subcategory}</td>
            <td class="num">${formatCurrency(item.total)}</td>
            <td class="num"><span class="pct-text">${item.pctOfTotal.toFixed(1)}%</span></td>
            <td><span class="pct-bar" style="width:${item.pctOfTotal}%;background:#ddd;"></span></td>
          </tr>`;
        }
      }
      
      html += `<tr class="total-row">
        <td>TOTAL EXPENSES</td>
        <td class="num">${formatCurrency(grandTotal)}</td>
        <td class="num">100%</td>
        <td></td>
      </tr></tbody></table>`;
      
      container.innerHTML = html;
    }

    function updateOccupancyTable() {
      const statements = dashboardData.statements || [];
      const container = document.getElementById('occupancyTableContainer');
      
      if (statements.length <= 1) {
        container.innerHTML = '';
        return;
      }
      
      const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const sorted = [...statements].sort((a,b) => a.year - b.year || a.month - b.month);
      
      let totals = { owner: 0, guest: 0, rental: 0, vacant: 0 };
      
      let html = `<table class="month-table"><thead><tr><th>Type</th>`;
      for (const s of sorted) html += `<th>${months[s.month]} ${s.year}</th>`;
      html += `<th>Total</th></tr></thead><tbody>`;
      
      html += `<tr><td>Owner</td>`;
      for (const s of sorted) { totals.owner += s.owner_nights || 0; html += `<td>${s.owner_nights || 0}</td>`; }
      html += `<td><strong>${totals.owner}</strong></td></tr>`;
      
      html += `<tr><td>Guest</td>`;
      for (const s of sorted) { totals.guest += s.guest_nights || 0; html += `<td>${s.guest_nights || 0}</td>`; }
      html += `<td><strong>${totals.guest}</strong></td></tr>`;
      
      html += `<tr><td>Rental</td>`;
      for (const s of sorted) { totals.rental += s.rental_nights || 0; html += `<td>${s.rental_nights || 0}</td>`; }
      html += `<td><strong>${totals.rental}</strong></td></tr>`;
      
      html += `<tr><td>Vacant</td>`;
      for (const s of sorted) { totals.vacant += s.vacant_nights || 0; html += `<td>${s.vacant_nights || 0}</td>`; }
      html += `<td><strong>${totals.vacant}</strong></td></tr>`;
      
      html += `<tr class="total-row"><td>Total</td>`;
      for (const s of sorted) {
        const t = (s.owner_nights||0) + (s.guest_nights||0) + (s.rental_nights||0) + (s.vacant_nights||0);
        html += `<td>${t}</td>`;
      }
      html += `<td><strong>${totals.owner + totals.guest + totals.rental + totals.vacant}</strong></td></tr>`;
      
      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function updateHeatmap() {
      const categories = dashboardData.expensesByCategory || [];
      const statements = dashboardData.statements || [];
      const container = document.getElementById('heatmapContainer');
      
      if (categories.length === 0 || statements.length <= 1) {
        container.innerHTML = '<p style="color:var(--text-light);">Need multiple months for heat map</p>';
        return;
      }
      
      const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const sorted = [...statements].sort((a,b) => a.year - b.year || a.month - b.month);
      const monthKeys = sorted.map(s => `${s.year}-${String(s.month).padStart(2,'0')}`);
      
      // Find max for heat scale
      let maxVal = 0;
      for (const cat of categories) {
        for (const item of cat.items) {
          for (const val of Object.values(item.monthly || {})) {
            if (val > maxVal) maxVal = val;
          }
        }
      }
      
      function getHeatClass(val) {
        if (!val || val === 0) return 'heat-0';
        const pct = val / maxVal;
        if (pct < 0.2) return 'heat-1';
        if (pct < 0.4) return 'heat-2';
        if (pct < 0.6) return 'heat-3';
        if (pct < 0.8) return 'heat-4';
        return 'heat-5';
      }
      
      let html = `<table class="heatmap"><thead><tr><th>Expense</th>`;
      for (const s of sorted) html += `<th>${months[s.month]}</th>`;
      html += `<th>Total</th></tr></thead><tbody>`;
      
      for (const cat of categories) {
        for (const item of cat.items) {
          html += `<tr><td>${item.subcategory}</td>`;
          for (const mk of monthKeys) {
            const val = item.monthly?.[mk] || 0;
            html += `<td class="${getHeatClass(val)}">${val > 0 ? formatCurrency(val) : '-'}</td>`;
          }
          html += `<td><strong>${formatCurrency(item.total)}</strong></td></tr>`;
        }
      }
      
      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function updateCharts() {
      Object.values(charts).forEach(c => c.destroy());
      charts = {};
      
      const statements = dashboardData.statements || [];
      const totals = dashboardData.totals || {};
      const categories = dashboardData.expensesByCategory || [];
      
      if (statements.length === 0) return;
      
      const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const sorted = [...statements].sort((a,b) => a.year - b.year || a.month - b.month);
      
      // Expense trend
      charts.expense = new Chart(document.getElementById('expenseChart'), {
        type: 'line',
        data: {
          labels: sorted.map(s => `${months[s.month]} ${s.year}`),
          datasets: [{
            label: 'Expenses',
            data: sorted.map(s => parseFloat(s.total_expenses) || 0),
            borderColor: '#c9a962',
            backgroundColor: 'rgba(201,169,98,0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }
        }
      });
      
      // Occupancy donut
      charts.occupancy = new Chart(document.getElementById('occupancyChart'), {
        type: 'doughnut',
        data: {
          labels: ['Owner', 'Guest', 'Rental', 'Vacant'],
          datasets: [{
            data: [totals.totalOwnerNights||0, totals.totalGuestNights||0, totals.totalRentalNights||0, totals.totalVacantNights||0],
            backgroundColor: ['#2d5a6e', '#c9a962', '#4a9e6e', '#ccc']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
      
      // Occupancy bar
      charts.occupancyBar = new Chart(document.getElementById('occupancyBarChart'), {
        type: 'bar',
        data: {
          labels: sorted.map(s => `${months[s.month]} ${s.year}`),
          datasets: [
            { label: 'Owner', data: sorted.map(s => s.owner_nights||0), backgroundColor: '#2d5a6e' },
            { label: 'Guest', data: sorted.map(s => s.guest_nights||0), backgroundColor: '#c9a962' },
            { label: 'Rental', data: sorted.map(s => s.rental_nights||0), backgroundColor: '#4a9e6e' },
            { label: 'Vacant', data: sorted.map(s => s.vacant_nights||0), backgroundColor: '#ccc' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { stacked: true }, y: { stacked: true } },
          plugins: { legend: { position: 'bottom' } }
        }
      });
      
      // Expense pie
      if (categories.length > 0) {
        const colors = ['#1a3a4a', '#2d5a6e', '#c9a962', '#4a9e6e', '#7a6e5e', '#a08060', '#5a8a9e'];
        charts.expensePie = new Chart(document.getElementById('expensePieChart'), {
          type: 'pie',
          data: {
            labels: categories.map(c => c.category),
            datasets: [{ data: categories.map(c => c.total), backgroundColor: colors.slice(0, categories.length) }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
        
        // Top cost drivers (horizontal bar)
        const allItems = categories.flatMap(c => c.items.map(i => ({ name: i.subcategory, total: i.total })));
        const topItems = allItems.sort((a,b) => b.total - a.total).slice(0, 8);
        
        charts.expenseBar = new Chart(document.getElementById('expenseBarChart'), {
          type: 'bar',
          data: {
            labels: topItems.map(i => i.name),
            datasets: [{ data: topItems.map(i => i.total), backgroundColor: '#c9a962' }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }
          }
        });
      }
    }

    function updateRecentFiles() {
      const files = dashboardData.recentFiles || [];
      const list = document.getElementById('fileList');
      if (files.length === 0) {
        list.innerHTML = '<p style="color:var(--text-light);font-size:0.85rem;">No uploads yet</p>';
        return;
      }
      list.innerHTML = files.slice(0, 10).map(f => `
        <div class="file-item">
          <span>${f.filename}</span>
          <span style="color:var(--text-light);">${new Date(f.upload_date).toLocaleDateString()}</span>
        </div>
      `).join('');
    }

    function formatCurrency(n) {
      return '$' + (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // Upload
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor = 'var(--accent)'; });
    uploadZone.addEventListener('dragleave', () => { uploadZone.style.borderColor = ''; });
    uploadZone.addEventListener('drop', e => {
      e.preventDefault();
      uploadZone.style.borderColor = '';
      if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => { if (fileInput.files.length) handleUpload(fileInput.files[0]); });

    async function handleUpload(file) {
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        uploadStatus.className = 'upload-status error';
        uploadStatus.textContent = 'Please upload a PDF';
        return;
      }
      uploadStatus.className = 'upload-status loading';
      uploadStatus.textContent = 'Processing...';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileType', 'statement');
      
      try {
        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          uploadStatus.className = 'upload-status success';
          uploadStatus.textContent = `Processed: ${file.name}`;
          await loadInitialData();
        } else {
          uploadStatus.className = 'upload-status error';
          uploadStatus.textContent = data.error || 'Failed';
        }
      } catch (err) {
        uploadStatus.className = 'upload-status error';
        uploadStatus.textContent = 'Upload failed';
      }
      fileInput.value = '';
    }

    checkAuth();
  </script>
</body>
</html>
