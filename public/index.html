<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Villa 8 | Amanyara Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --primary: #1a3a4a; --primary-light: #2d5a6e; --accent: #c9a962; --text: #1a1a1a; --text-light: #666; --card-bg: rgba(255,255,255,0.94); --shadow: 0 8px 32px rgba(0,0,0,0.1); --owner: #2d5a6e; --guest: #c9a962; --rental: #4a9e6e; --vacant: #bbb; --success: #2e7d32; --danger: #c62828; }
    body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #e8e4dc 0%, #d4cfc4 50%, #c9c4b8 100%); min-height: 100vh; color: var(--text); }
    h1,h2,h3,h4 { font-family: 'Cormorant Garamond', serif; font-weight: 400; }
    
    .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .login-card { background: var(--card-bg); border-radius: 24px; padding: 3rem; width: 100%; max-width: 420px; box-shadow: var(--shadow); }
    .login-logo { text-align: center; margin-bottom: 2rem; }
    .login-logo h1 { font-size: 2.5rem; color: var(--primary); }
    .login-logo span { font-size: 0.85rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.3em; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-light); margin-bottom: 0.5rem; }
    .form-group input { width: 100%; padding: 0.85rem 1rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; font-family: inherit; font-size: 0.95rem; background: white; }
    .btn { padding: 0.85rem 1.5rem; border: none; border-radius: 10px; font-family: inherit; font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.75rem; }
    .btn-outline { background: white; border: 1px solid rgba(0,0,0,0.15); color: var(--text); }
    .btn-outline:hover { background: var(--primary); color: white; }
    .error-message { background: #fee; color: #c00; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
    
    .dashboard { display: none; min-height: 100vh; }
    .dashboard.active { display: block; }
    .login-container.hidden { display: none; }
    
    .header { background: var(--card-bg); padding: 0.85rem 2rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
    .header-brand { display: flex; align-items: center; gap: 1rem; }
    .header-brand h1 { font-size: 1.4rem; color: var(--primary); }
    .header-brand span { font-size: 0.65rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.2em; background: rgba(201,169,98,0.15); padding: 0.3rem 0.6rem; border-radius: 4px; }
    .header-btn { padding: 0.4rem 0.8rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; background: transparent; font-family: inherit; font-size: 0.75rem; cursor: pointer; }
    
    .main-content { padding: 1.5rem 2rem; max-width: 1900px; margin: 0 auto; }
    
    .view-selector { background: var(--card-bg); border-radius: 14px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; box-shadow: var(--shadow); }
    .view-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .view-header label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); }
    .view-header select { padding: 0.5rem 0.75rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; font-family: inherit; font-size: 0.85rem; background: white; }
    .view-info { margin-left: auto; font-size: 0.8rem; color: var(--text-light); }
    
    .month-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid rgba(0,0,0,0.05); }
    .month-chip { display: flex; align-items: center; gap: 0.4rem; padding: 0.45rem 0.7rem; background: white; border: 1px solid rgba(0,0,0,0.12); border-radius: 20px; cursor: pointer; font-size: 0.75rem; transition: all 0.15s; user-select: none; }
    .month-chip:hover { border-color: var(--accent); }
    .month-chip.selected { background: var(--primary); color: white; border-color: var(--primary); }
    .month-chip .check { width: 14px; height: 14px; border: 2px solid rgba(0,0,0,0.25); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .month-chip.selected .check { background: white; border-color: white; color: var(--primary); }
    
    .tabs { display: flex; gap: 0.35rem; margin-bottom: 1.25rem; background: var(--card-bg); border-radius: 10px; padding: 0.4rem; box-shadow: var(--shadow); flex-wrap: wrap; }
    .tab-btn { padding: 0.6rem 1rem; border: none; border-radius: 6px; font-family: inherit; font-size: 0.75rem; font-weight: 500; color: var(--text-light); background: transparent; cursor: pointer; }
    .tab-btn:hover { color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.25rem; }
    .card { background: var(--card-bg); border-radius: 14px; padding: 1.25rem; box-shadow: var(--shadow); margin-bottom: 1.25rem; }
    .card h3 { font-size: 1rem; color: var(--primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); }
    
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .kpi { background: var(--card-bg); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); }
    .kpi-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); margin-bottom: 0.3rem; }
    .kpi-value { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; font-weight: 500; color: var(--primary); }
    .kpi-value.accent { color: var(--accent); }
    .kpi-value.success { color: var(--success); }
    .kpi-value.danger { color: var(--danger); }
    .kpi-sub { font-size: 0.6rem; color: var(--text-light); margin-top: 0.2rem; }
    
    .chart-container { position: relative; height: 240px; }
    .chart-container.tall { height: 300px; }
    
    .occ-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .occ-card { background: var(--card-bg); border-radius: 10px; padding: 1rem; box-shadow: var(--shadow); text-align: center; border-left: 4px solid; }
    .occ-card.owner { border-color: var(--owner); }
    .occ-card.guest { border-color: var(--guest); }
    .occ-card.rental { border-color: var(--rental); }
    .occ-card.vacant { border-color: var(--vacant); }
    .occ-value { font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 600; }
    .occ-card.owner .occ-value { color: var(--owner); }
    .occ-card.guest .occ-value { color: var(--guest); }
    .occ-card.rental .occ-value { color: var(--rental); }
    .occ-card.vacant .occ-value { color: var(--vacant); }
    .occ-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); margin-top: 0.3rem; }
    .occ-pct { font-size: 0.8rem; color: var(--text-light); font-weight: 500; }
    
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .data-table th { text-align: left; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-light); padding: 0.6rem 0.5rem; border-bottom: 2px solid rgba(0,0,0,0.1); font-weight: 600; }
    .data-table th.r { text-align: right; }
    .data-table td { padding: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.04); }
    .data-table td.r { text-align: right; font-variant-numeric: tabular-nums; }
    .data-table tr.cat { background: rgba(0,0,0,0.02); }
    .data-table tr.cat td { font-weight: 600; padding: 0.6rem 0.5rem; }
    .data-table tr.cat td:first-child { color: var(--primary); }
    .data-table tr.item td:first-child { padding-left: 1.25rem; color: var(--text-light); }
    .data-table tr.total { background: var(--primary); color: white; }
    .data-table tr.total td { padding: 0.7rem 0.5rem; font-weight: 600; }
    .data-table tr.highlight { background: rgba(201,169,98,0.15); }
    .pct-bar { display: inline-block; height: 6px; background: var(--accent); border-radius: 3px; vertical-align: middle; }
    
    /* Treemap styles */
    .treemap { display: flex; flex-wrap: wrap; gap: 4px; padding: 4px; background: #f5f5f5; border-radius: 12px; min-height: 350px; align-content: flex-start; }
    .treemap-item { border-radius: 8px; padding: 0.75rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
    .treemap-item:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10; }
    .treemap-item .label { font-size: 0.7rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; opacity: 0.9; }
    .treemap-item .value { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; font-weight: 600; margin-top: 0.25rem; }
    .treemap-item .pct { font-size: 0.65rem; opacity: 0.8; margin-top: 0.15rem; }
    .treemap-item.small .label { font-size: 0.6rem; }
    .treemap-item.small .value { font-size: 1rem; }
    
    /* Floating Chat */
    .chat-fab { position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 16px rgba(0,0,0,0.3); cursor: pointer; font-size: 1.5rem; z-index: 1000; transition: transform 0.2s, background 0.2s; }
    .chat-fab:hover { background: var(--primary-light); transform: scale(1.05); }
    .chat-fab.open { background: var(--danger); }
    
    .chat-panel { position: fixed; bottom: 100px; right: 24px; width: 380px; max-width: calc(100vw - 48px); height: 500px; max-height: calc(100vh - 150px); background: var(--card-bg); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); z-index: 999; display: none; flex-direction: column; overflow: hidden; }
    .chat-panel.open { display: flex; }
    .chat-header { background: var(--primary); color: white; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; }
    .chat-header h4 { font-size: 1rem; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; background: #f9f9f9; }
    .chat-message { margin-bottom: 1rem; max-width: 85%; }
    .chat-message.user { margin-left: auto; }
    .chat-message .bubble { padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.85rem; line-height: 1.5; }
    .chat-message.user .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .chat-message.ai .bubble { background: white; border: 1px solid rgba(0,0,0,0.1); border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; gap: 0.5rem; padding: 0.75rem; border-top: 1px solid rgba(0,0,0,0.1); background: white; }
    .chat-input-area input { flex: 1; padding: 0.6rem 0.75rem; border: 1px solid rgba(0,0,0,0.15); border-radius: 20px; font-family: inherit; font-size: 0.85rem; }
    .chat-input-area button { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; }
    
    .upload-zone { border: 2px dashed rgba(0,0,0,0.15); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; }
    .upload-zone:hover { border-color: var(--accent); background: rgba(201,169,98,0.05); }
    .upload-status { margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none; font-size: 0.8rem; white-space: pre-line; }
    .upload-status.success { display: block; background: #e8f5e9; color: var(--success); }
    .upload-status.error { display: block; background: #ffebee; color: var(--danger); }
    .upload-status.loading { display: block; background: #e3f2fd; color: #1565c0; }
    .file-input { display: none; }
    
    @media (max-width: 1000px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } .occ-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .chat-panel { right: 12px; bottom: 90px; width: calc(100vw - 24px); } }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <div class="login-logo"><h1>Villa 8</h1><span>Amanyara</span></div>
      <div class="error-message" id="loginError"></div>
      <form id="loginForm">
        <div class="form-group"><label>Username</label><input type="text" id="username" required></div>
        <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
        <button type="submit" class="btn btn-primary" style="width:100%">Sign In</button>
      </form>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <header class="header">
      <div class="header-brand"><h1>Villa 8</h1><span>Amanyara</span></div>
      <div><span id="welcomeUser" style="margin-right:1rem;font-size:0.8rem;"></span><button class="header-btn" onclick="logout()">Logout</button></div>
    </header>

    <main class="main-content">
      <div class="view-selector">
        <div class="view-header">
          <label>Quick Select:</label>
          <select id="quickSelect" onchange="quickSelectChange()"><option value="">--</option></select>
          <button class="btn btn-outline btn-sm" onclick="selectAll()">All</button>
          <button class="btn btn-outline btn-sm" onclick="selectNone()">None</button>
          <span class="view-info" id="viewInfo">No months selected</span>
        </div>
        <div class="month-grid" id="monthGrid"></div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="occupancy">Occupancy</button>
        <button class="tab-btn" data-tab="expenses">Expenses</button>
        <button class="tab-btn" data-tab="revenue">Revenue</button>
        <button class="tab-btn" data-tab="treemap">Expense Map</button>
        <button class="tab-btn" data-tab="upload">Upload</button>
      </div>

      <!-- OVERVIEW TAB -->
      <div class="tab-content active" id="tab-overview">
        <div class="kpi-grid">
          <div class="kpi"><div class="kpi-label">Owner Revenue (50%)</div><div class="kpi-value accent" id="kpiRevenue">--</div></div>
          <div class="kpi"><div class="kpi-label">Total Expenses</div><div class="kpi-value" id="kpiExpenses">--</div><div class="kpi-sub" id="kpiExpPct"></div></div>
          <div class="kpi"><div class="kpi-label">Net Income</div><div class="kpi-value" id="kpiNet">--</div></div>
          <div class="kpi"><div class="kpi-label">Avg Daily Rate</div><div class="kpi-value accent" id="kpiADR">--</div><div class="kpi-sub">per rental night</div></div>
          <div class="kpi"><div class="kpi-label">Occupied Nights</div><div class="kpi-value" id="kpiOccupied">--</div><div class="kpi-sub" id="kpiOccRate"></div></div>
          <div class="kpi"><div class="kpi-label">Cost/Occupied Night</div><div class="kpi-value" id="kpiCostNight">--</div></div>
        </div>
        
        <div class="grid-2">
          <div class="card"><h3>Revenue vs Expenses</h3><div class="chart-container tall"><canvas id="revenueExpenseChart"></canvas></div></div>
          <div class="card"><h3>Occupancy Mix</h3><div class="chart-container tall"><canvas id="occupancyChart"></canvas></div></div>
        </div>
        
        <div class="grid-3">
          <div class="card"><h3>Monthly Net Income</h3><div class="chart-container"><canvas id="netIncomeChart"></canvas></div></div>
          <div class="card"><h3>Expense Breakdown</h3><div class="chart-container"><canvas id="expensePieChart"></canvas></div></div>
          <div class="card"><h3>ADR by Month</h3><div class="chart-container"><canvas id="adrChart"></canvas></div></div>
        </div>
      </div>

      <!-- OCCUPANCY TAB -->
      <div class="tab-content" id="tab-occupancy">
        <div class="occ-grid">
          <div class="occ-card owner"><div class="occ-value" id="occOwner">--</div><div class="occ-label">Owner Nights</div><div class="occ-pct" id="occOwnerPct">--</div></div>
          <div class="occ-card guest"><div class="occ-value" id="occGuest">--</div><div class="occ-label">Guest Nights</div><div class="occ-pct" id="occGuestPct">--</div></div>
          <div class="occ-card rental"><div class="occ-value" id="occRental">--</div><div class="occ-label">Rental Nights</div><div class="occ-pct" id="occRentalPct">--</div></div>
          <div class="occ-card vacant"><div class="occ-value" id="occVacant">--</div><div class="occ-label">Vacant Nights</div><div class="occ-pct" id="occVacantPct">--</div></div>
        </div>
        <div class="grid-2">
          <div class="card"><h3>Occupancy Over Time</h3><div class="chart-container tall"><canvas id="occupancyBarChart"></canvas></div></div>
          <div class="card"><h3>Usage Pattern</h3><div class="chart-container tall"><canvas id="usagePatternChart"></canvas></div></div>
        </div>
        <div class="card"><h3>Monthly Breakdown</h3><div id="occTableContainer"></div></div>
      </div>

      <!-- EXPENSES TAB -->
      <div class="tab-content" id="tab-expenses">
        <div class="grid-2">
          <div class="card"><h3>Expense Trend</h3><div class="chart-container tall"><canvas id="expenseTrendChart"></canvas></div></div>
          <div class="card"><h3>Top Cost Drivers</h3><div class="chart-container tall"><canvas id="expenseBarChart"></canvas></div></div>
        </div>
        <div class="card"><h3>Expense Breakdown by Category</h3><div id="expenseTableContainer"></div></div>
      </div>

      <!-- REVENUE TAB -->
      <div class="tab-content" id="tab-revenue">
        <div class="kpi-grid">
          <div class="kpi"><div class="kpi-label">Gross Revenue</div><div class="kpi-value accent" id="kpiGross">--</div></div>
          <div class="kpi"><div class="kpi-label">Owner Share (50%)</div><div class="kpi-value accent" id="kpiOwnerShare">--</div></div>
          <div class="kpi"><div class="kpi-label">Rental Nights</div><div class="kpi-value" id="kpiRentalNights">--</div></div>
          <div class="kpi"><div class="kpi-label">Avg Daily Rate</div><div class="kpi-value accent" id="kpiADR2">--</div></div>
        </div>
        <div class="grid-2">
          <div class="card"><h3>Revenue by Month</h3><div class="chart-container tall"><canvas id="revenueBarChart"></canvas></div></div>
          <div class="card"><h3>ADR vs Rental Nights</h3><div class="chart-container tall"><canvas id="adrVsNightsChart"></canvas></div></div>
        </div>
        <div class="card"><h3>Rental Activity Summary</h3><div id="revenueTableContainer"></div></div>
      </div>

      <!-- TREEMAP TAB -->
      <div class="tab-content" id="tab-treemap">
        <div class="card">
          <h3>Expense Treemap</h3>
          <p style="font-size:0.75rem;color:var(--text-light);margin-bottom:1rem;">Larger boxes = higher expenses. Click for details.</p>
          <div class="treemap" id="treemapContainer"></div>
        </div>
        <div class="card"><h3>80/20 Pareto Analysis</h3><p style="font-size:0.75rem;color:var(--text-light);margin-bottom:1rem;">Highlighted items represent ~80% of total costs</p><div id="paretoTableContainer"></div></div>
      </div>

      <!-- UPLOAD TAB -->
      <div class="tab-content" id="tab-upload">
        <div class="grid-2">
          <div class="card">
            <h3>Upload Excel Statement</h3>
            <div class="upload-zone" id="uploadZone">
              <p style="font-size:2rem;opacity:0.5;">üìä</p>
              <p style="color:var(--accent);font-weight:500;">Click to upload</p>
              <p style="color:var(--text-light);font-size:0.85rem;">Amanyara YTD Excel file (.xlsx)</p>
              <p style="color:var(--text-light);font-size:0.75rem;margin-top:0.5rem;">One file contains all months!</p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            <div class="upload-status" id="uploadStatus"></div>
            <div id="uploadResults" style="margin-top:1rem;"></div>
          </div>
          <div class="card">
            <h3>Data Management</h3>
            <p style="color:var(--text-light);font-size:0.85rem;margin-bottom:1rem;">Clear all existing data before uploading a fresh Excel file.</p>
            <button class="btn btn-outline" onclick="clearAllData()" style="background:#fee;border-color:#c00;color:#c00;">üóëÔ∏è Clear All Data</button>
          </div>
        </div>
      </div>
    </main>

    <!-- Floating Chat Button -->
    <button class="chat-fab" id="chatFab" onclick="toggleChat()">üí¨</button>
    <div class="chat-panel" id="chatPanel">
      <div class="chat-header">
        <span style="font-size:1.5rem;">ü§ñ</span>
        <h4>Villa Assistant</h4>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message ai"><div class="bubble">Hi! Ask me anything about your villa finances - expenses, revenue, occupancy trends, or comparisons.</div></div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null, dashboardData = null, allStatements = [], availableYears = [], charts = {}, selectedIds = new Set();
    const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const treemapColors = ['#1a3a4a', '#2d5a6e', '#c9a962', '#4a9e6e', '#7a6e5e', '#a08060', '#5d7a8c', '#8b7355', '#6b8e6b', '#9a8070'];

    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/status');
        const data = await res.json();
        if (data.authenticated) { currentUser = data.username; showDashboard(); }
      } catch (err) {}
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorEl = document.getElementById('loginError');
      try {
        const res = await fetch('/api/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: document.getElementById('username').value, password: document.getElementById('password').value })
        });
        const data = await res.json();
        if (data.success) { currentUser = data.username; showDashboard(); }
        else { errorEl.textContent = data.error || 'Login failed'; errorEl.style.display = 'block'; }
      } catch (err) { errorEl.textContent = 'Connection error'; errorEl.style.display = 'block'; }
    });

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('active');
    }

    async function showDashboard() {
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('welcomeUser').textContent = `Welcome, ${currentUser}`;
      await loadInitialData();
    }

    async function loadInitialData() {
      const res = await fetch('/api/statements');
      const data = await res.json();
      allStatements = data.statements || [];
      availableYears = data.availableYears || [];
      buildMonthGrid();
      buildQuickSelect();
      if (allStatements.length > 0) {
        selectedIds = new Set(allStatements.map(s => s.id));
        updateChipStyles();
        loadSelectedData();
      }
    }

    function buildQuickSelect() {
      document.getElementById('quickSelect').innerHTML = `<option value="">-- Quick Select --</option>
        ${availableYears.map(y => `<option value="year-${y}">All of ${y}</option>`).join('')}
        <option value="rolling12">Rolling 12 Months</option>`;
    }

    function buildMonthGrid() {
      document.getElementById('monthGrid').innerHTML = allStatements.map(s => `
        <div class="month-chip" data-id="${s.id}" onclick="toggleMonth(${s.id})">
          <span class="check">‚úì</span>
          <span>${monthNames[s.month]} ${s.year}</span>
        </div>
      `).join('');
    }

    function toggleMonth(id) {
      selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id);
      updateChipStyles();
      loadSelectedData();
    }

    function updateChipStyles() {
      document.querySelectorAll('.month-chip').forEach(chip => {
        chip.classList.toggle('selected', selectedIds.has(parseInt(chip.dataset.id)));
      });
    }

    function selectAll() { selectedIds = new Set(allStatements.map(s => s.id)); updateChipStyles(); loadSelectedData(); }
    function selectNone() { selectedIds.clear(); updateChipStyles(); document.getElementById('viewInfo').textContent = 'No months selected'; }

    function quickSelectChange() {
      const mode = document.getElementById('quickSelect').value;
      if (!mode) return;
      if (mode === 'rolling12') {
        const sorted = [...allStatements].sort((a, b) => b.year - a.year || b.month - a.month);
        selectedIds = new Set(sorted.slice(0, 12).map(s => s.id));
      } else if (mode.startsWith('year-')) {
        const year = parseInt(mode.split('-')[1]);
        selectedIds = new Set(allStatements.filter(s => s.year === year).map(s => s.id));
      }
      updateChipStyles();
      loadSelectedData();
    }

    async function loadSelectedData() {
      if (selectedIds.size === 0) { document.getElementById('viewInfo').textContent = 'No months selected'; return; }
      const res = await fetch('/api/dashboard?ids=' + Array.from(selectedIds).join(','));
      dashboardData = await res.json();
      document.getElementById('viewInfo').textContent = `${dashboardData.statements.length} month(s) selected`;
      updateDisplay();
    }

    function fmt(n) { return '$' + (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }

    function updateDisplay() {
      if (!dashboardData) return;
      const t = dashboardData.totals || {};
      const stmts = dashboardData.statements || [];
      
      const occupiedNights = (t.totalOwnerNights||0) + (t.totalGuestNights||0) + (t.totalRentalNights||0);
      const totalNights = occupiedNights + (t.totalVacantNights||0);
      const net = (t.totalRevenue || 0) - (t.totalExpenses || 0);
      
      // ADR = Gross Revenue / Rental Nights (Gross = Owner * 2)
      const grossRevenue = (t.totalRevenue || 0) * 2;
      const adr = t.totalRentalNights > 0 ? grossRevenue / t.totalRentalNights : 0;
      
      // Overview KPIs
      document.getElementById('kpiRevenue').textContent = fmt(t.totalRevenue);
      document.getElementById('kpiExpenses').textContent = fmt(t.totalExpenses);
      document.getElementById('kpiExpPct').textContent = t.totalRevenue > 0 ? `${(t.totalExpenses/t.totalRevenue*100).toFixed(0)}% of revenue` : '';
      
      const netEl = document.getElementById('kpiNet');
      netEl.textContent = fmt(net);
      netEl.className = 'kpi-value ' + (net >= 0 ? 'success' : 'danger');
      
      document.getElementById('kpiADR').textContent = adr > 0 ? fmt(adr) : '--';
      document.getElementById('kpiOccupied').textContent = occupiedNights;
      document.getElementById('kpiOccRate').textContent = totalNights > 0 ? `${(occupiedNights/totalNights*100).toFixed(0)}% occupancy` : '';
      document.getElementById('kpiCostNight').textContent = occupiedNights > 0 ? fmt(t.totalExpenses / occupiedNights) : '--';
      
      // Occupancy cards
      document.getElementById('occOwner').textContent = t.totalOwnerNights || 0;
      document.getElementById('occGuest').textContent = t.totalGuestNights || 0;
      document.getElementById('occRental').textContent = t.totalRentalNights || 0;
      document.getElementById('occVacant').textContent = t.totalVacantNights || 0;
      if (totalNights > 0) {
        document.getElementById('occOwnerPct').textContent = `${(t.totalOwnerNights/totalNights*100).toFixed(1)}%`;
        document.getElementById('occGuestPct').textContent = `${(t.totalGuestNights/totalNights*100).toFixed(1)}%`;
        document.getElementById('occRentalPct').textContent = `${(t.totalRentalNights/totalNights*100).toFixed(1)}%`;
        document.getElementById('occVacantPct').textContent = `${(t.totalVacantNights/totalNights*100).toFixed(1)}%`;
      }
      
      // Revenue tab KPIs
      document.getElementById('kpiGross').textContent = fmt(grossRevenue);
      document.getElementById('kpiOwnerShare').textContent = fmt(t.totalRevenue);
      document.getElementById('kpiRentalNights').textContent = t.totalRentalNights || 0;
      document.getElementById('kpiADR2').textContent = adr > 0 ? fmt(adr) : '--';
      
      updateCharts();
      updateTables();
      updateTreemap();
    }

    function updateTreemap() {
      const cats = dashboardData?.expensesByCategory || [];
      const container = document.getElementById('treemapContainer');
      if (!cats.length) { container.innerHTML = '<p style="color:var(--text-light);padding:2rem;text-align:center;">No expense data</p>'; return; }
      
      const total = cats.reduce((s, c) => s + c.total, 0);
      const containerWidth = container.offsetWidth - 8;
      const containerHeight = 350;
      
      // Build treemap layout
      let html = '';
      cats.forEach((cat, i) => {
        const pct = (cat.total / total * 100);
        const area = (pct / 100) * containerWidth * containerHeight;
        const size = Math.sqrt(area);
        const minSize = Math.max(80, size * 0.8);
        const color = treemapColors[i % treemapColors.length];
        const isSmall = pct < 8;
        
        html += `<div class="treemap-item${isSmall ? ' small' : ''}" style="background:${color};flex:${Math.max(pct, 5)} 1 ${minSize}px;min-width:${minSize}px;min-height:${Math.min(minSize, 120)}px;" onclick="showCategoryDetail('${cat.category}')">
          <div class="label">${cat.category}</div>
          <div class="value">${fmt(cat.total)}</div>
          <div class="pct">${pct.toFixed(1)}%</div>
        </div>`;
      });
      
      container.innerHTML = html;
    }

    function showCategoryDetail(category) {
      const cats = dashboardData?.expensesByCategory || [];
      const cat = cats.find(c => c.category === category);
      if (!cat) return;
      
      let details = `${category}\n${fmt(cat.total)} (${cat.pctOfTotal.toFixed(1)}% of total)\n\n`;
      cat.items.forEach(item => {
        details += `‚Ä¢ ${item.subcategory}: ${fmt(item.total)}\n`;
      });
      alert(details);
    }

    function updateTables() {
      const cats = dashboardData?.expensesByCategory || [];
      const stmts = dashboardData?.statements || [];
      
      // Expense table
      const expContainer = document.getElementById('expenseTableContainer');
      if (!cats.length) { expContainer.innerHTML = '<p style="color:var(--text-light)">No expense data</p>'; }
      else {
        const total = cats.reduce((s, c) => s + c.total, 0);
        let html = `<table class="data-table"><thead><tr><th>Category / Item</th><th class="r">Amount</th><th class="r">%</th><th style="width:100px"></th></tr></thead><tbody>`;
        for (const cat of cats) {
          html += `<tr class="cat"><td>${cat.category}</td><td class="r">${fmt(cat.total)}</td><td class="r">${cat.pctOfTotal.toFixed(1)}%</td><td><span class="pct-bar" style="width:${cat.pctOfTotal}%"></span></td></tr>`;
          for (const item of cat.items) html += `<tr class="item"><td>${item.subcategory}</td><td class="r">${fmt(item.total)}</td><td class="r">${item.pctOfTotal.toFixed(1)}%</td><td><span class="pct-bar" style="width:${item.pctOfTotal}%;background:#ddd"></span></td></tr>`;
        }
        html += `<tr class="total"><td>TOTAL</td><td class="r">${fmt(total)}</td><td class="r">100%</td><td></td></tr></tbody></table>`;
        expContainer.innerHTML = html;
      }

      // Pareto table
      const items = dashboardData?.paretoAnalysis || [];
      const paretoContainer = document.getElementById('paretoTableContainer');
      if (!items.length) { paretoContainer.innerHTML = '<p style="color:var(--text-light)">No data</p>'; }
      else {
        let html = `<table class="data-table"><thead><tr><th>#</th><th>Item</th><th>Category</th><th class="r">Amount</th><th class="r">%</th><th class="r">Cumul.</th></tr></thead><tbody>`;
        items.forEach((item, i) => {
          const hl = item.cumulativePct <= 80 ? ' highlight' : '';
          html += `<tr class="${hl}"><td>${i+1}</td><td>${item.name}</td><td style="color:var(--text-light)">${item.category}</td><td class="r">${fmt(item.total)}</td><td class="r">${item.pctOfTotal.toFixed(1)}%</td><td class="r"><strong>${item.cumulativePct.toFixed(0)}%</strong></td></tr>`;
        });
        html += `</tbody></table>`;
        paretoContainer.innerHTML = html;
      }

      // Occupancy table
      const occContainer = document.getElementById('occTableContainer');
      if (!stmts.length) { occContainer.innerHTML = ''; }
      else {
        const sorted = [...stmts].sort((a, b) => a.year - b.year || a.month - b.month);
        let totals = { o: 0, g: 0, r: 0, v: 0 };
        let html = `<table class="data-table"><thead><tr><th>Month</th><th class="r">Owner</th><th class="r">Guest</th><th class="r">Rental</th><th class="r">Vacant</th><th class="r">Total</th></tr></thead><tbody>`;
        for (const s of sorted) {
          const o = parseInt(s.owner_nights) || 0, g = parseInt(s.guest_nights) || 0, r = parseInt(s.rental_nights) || 0, v = parseInt(s.vacant_nights) || 0;
          totals.o += o; totals.g += g; totals.r += r; totals.v += v;
          html += `<tr><td>${monthNames[s.month]} ${s.year}</td><td class="r">${o}</td><td class="r">${g}</td><td class="r">${r}</td><td class="r">${v}</td><td class="r">${o+g+r+v}</td></tr>`;
        }
        html += `<tr class="total"><td>Total</td><td class="r">${totals.o}</td><td class="r">${totals.g}</td><td class="r">${totals.r}</td><td class="r">${totals.v}</td><td class="r">${totals.o+totals.g+totals.r+totals.v}</td></tr></tbody></table>`;
        occContainer.innerHTML = html;
      }

      // Revenue table
      const revContainer = document.getElementById('revenueTableContainer');
      const rentalMonths = stmts.filter(s => parseFloat(s.owner_revenue_share) > 0);
      if (!rentalMonths.length) { revContainer.innerHTML = '<p style="color:var(--text-light)">No rental revenue in selected period</p>'; }
      else {
        const sorted = [...rentalMonths].sort((a, b) => a.year - b.year || a.month - b.month);
        let html = `<table class="data-table"><thead><tr><th>Month</th><th class="r">Rental Nights</th><th class="r">Gross Revenue</th><th class="r">Owner Share (50%)</th><th class="r">ADR</th></tr></thead><tbody>`;
        let totalNights = 0, totalGross = 0, totalOwner = 0;
        for (const s of sorted) {
          const nights = parseInt(s.rental_nights) || 0;
          const owner = parseFloat(s.owner_revenue_share) || 0;
          const gross = owner * 2;
          const adr = nights > 0 ? gross / nights : 0;
          totalNights += nights; totalGross += gross; totalOwner += owner;
          html += `<tr><td>${monthNames[s.month]} ${s.year}</td><td class="r">${nights}</td><td class="r">${fmt(gross)}</td><td class="r">${fmt(owner)}</td><td class="r">${fmt(adr)}</td></tr>`;
        }
        const avgAdr = totalNights > 0 ? totalGross / totalNights : 0;
        html += `<tr class="total"><td>Total / Avg</td><td class="r">${totalNights}</td><td class="r">${fmt(totalGross)}</td><td class="r">${fmt(totalOwner)}</td><td class="r">${fmt(avgAdr)}</td></tr></tbody></table>`;
        revContainer.innerHTML = html;
      }
    }

    function updateCharts() {
      Object.values(charts).forEach(c => c?.destroy());
      charts = {};
      if (!dashboardData) return;
      
      const stmts = dashboardData.statements || [];
      const t = dashboardData.totals || {};
      const cats = dashboardData.expensesByCategory || [];
      if (!stmts.length) return;
      
      const sorted = [...stmts].sort((a, b) => a.year - b.year || a.month - b.month);
      const labels = sorted.map(s => `${monthNames[s.month]} ${s.year}`);
      
      // Revenue vs Expenses
      charts.revenueExpense = new Chart(document.getElementById('revenueExpenseChart'), {
        type: 'bar', data: {
          labels,
          datasets: [
            { label: 'Revenue', data: sorted.map(s => parseFloat(s.owner_revenue_share) || 0), backgroundColor: '#c9a962' },
            { label: 'Expenses', data: sorted.map(s => parseFloat(s.total_expenses) || 0), backgroundColor: '#2d5a6e' }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }, plugins: { legend: { position: 'bottom' } } }
      });
      
      // Occupancy donut
      charts.occupancy = new Chart(document.getElementById('occupancyChart'), {
        type: 'doughnut', data: {
          labels: ['Owner', 'Guest', 'Rental', 'Vacant'],
          datasets: [{ data: [t.totalOwnerNights||0, t.totalGuestNights||0, t.totalRentalNights||0, t.totalVacantNights||0], backgroundColor: ['#2d5a6e', '#c9a962', '#4a9e6e', '#ccc'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
      });
      
      // Net Income
      charts.netIncome = new Chart(document.getElementById('netIncomeChart'), {
        type: 'bar', data: {
          labels,
          datasets: [{ label: 'Net', data: sorted.map(s => (parseFloat(s.owner_revenue_share) || 0) - (parseFloat(s.total_expenses) || 0)), backgroundColor: sorted.map(s => ((parseFloat(s.owner_revenue_share) || 0) - (parseFloat(s.total_expenses) || 0)) >= 0 ? '#4a9e6e' : '#c62828') }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }, plugins: { legend: { display: false } } }
      });
      
      // Expense pie
      if (cats.length) {
        charts.expensePie = new Chart(document.getElementById('expensePieChart'), {
          type: 'pie', data: { labels: cats.map(c => c.category), datasets: [{ data: cats.map(c => c.total), backgroundColor: treemapColors }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } } } }
        });
      }
      
      // ADR Chart
      const rentalMonths = sorted.filter(s => parseInt(s.rental_nights) > 0);
      if (rentalMonths.length) {
        charts.adr = new Chart(document.getElementById('adrChart'), {
          type: 'bar', data: {
            labels: rentalMonths.map(s => `${monthNames[s.month]}`),
            datasets: [{ label: 'ADR', data: rentalMonths.map(s => { const n = parseInt(s.rental_nights) || 1; const g = (parseFloat(s.owner_revenue_share) || 0) * 2; return g / n; }), backgroundColor: '#c9a962' }]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: v => '$' + v.toLocaleString() } } }, plugins: { legend: { display: false } } }
        });
      }
      
      // Occupancy stacked bar
      charts.occupancyBar = new Chart(document.getElementById('occupancyBarChart'), {
        type: 'bar', data: {
          labels,
          datasets: [
            { label: 'Owner', data: sorted.map(s => s.owner_nights || 0), backgroundColor: '#2d5a6e' },
            { label: 'Guest', data: sorted.map(s => s.guest_nights || 0), backgroundColor: '#c9a962' },
            { label: 'Rental', data: sorted.map(s => s.rental_nights || 0), backgroundColor: '#4a9e6e' },
            { label: 'Vacant', data: sorted.map(s => s.vacant_nights || 0), backgroundColor: '#ccc' }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, max: 31 } }, plugins: { legend: { position: 'bottom' } } }
      });
      
      // Usage pattern
      charts.usagePattern = new Chart(document.getElementById('usagePatternChart'), {
        type: 'line', data: {
          labels,
          datasets: [
            { label: 'Owner+Guest', data: sorted.map(s => (parseInt(s.owner_nights)||0) + (parseInt(s.guest_nights)||0)), borderColor: '#2d5a6e', backgroundColor: 'rgba(45,90,110,0.1)', fill: true, tension: 0.4 },
            { label: 'Rental', data: sorted.map(s => parseInt(s.rental_nights) || 0), borderColor: '#4a9e6e', backgroundColor: 'rgba(74,158,110,0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
      
      // Expense trend
      charts.expenseTrend = new Chart(document.getElementById('expenseTrendChart'), {
        type: 'line', data: {
          labels,
          datasets: [{ label: 'Expenses', data: sorted.map(s => parseFloat(s.total_expenses) || 0), borderColor: '#c9a962', backgroundColor: 'rgba(201,169,98,0.1)', fill: true, tension: 0.4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }, plugins: { legend: { display: false } } }
      });
      
      // Top expenses bar
      const topItems = cats.flatMap(c => c.items).sort((a, b) => b.total - a.total).slice(0, 8);
      if (topItems.length) {
        charts.expenseBar = new Chart(document.getElementById('expenseBarChart'), {
          type: 'bar', data: { labels: topItems.map(i => i.subcategory), datasets: [{ data: topItems.map(i => i.total), backgroundColor: '#c9a962' }] },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } } }
        });
      }
      
      // Revenue bar
      charts.revenueBar = new Chart(document.getElementById('revenueBarChart'), {
        type: 'bar', data: {
          labels,
          datasets: [{ label: 'Revenue', data: sorted.map(s => parseFloat(s.owner_revenue_share) || 0), backgroundColor: sorted.map(s => parseFloat(s.owner_revenue_share) > 0 ? '#c9a962' : '#eee') }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }, plugins: { legend: { display: false } } }
      });
      
      // ADR vs Nights
      if (rentalMonths.length) {
        charts.adrVsNights = new Chart(document.getElementById('adrVsNightsChart'), {
          type: 'scatter', data: {
            datasets: [{
              label: 'Months',
              data: rentalMonths.map(s => {
                const n = parseInt(s.rental_nights) || 0;
                const g = (parseFloat(s.owner_revenue_share) || 0) * 2;
                return { x: n, y: n > 0 ? g / n : 0 };
              }),
              backgroundColor: '#c9a962',
              pointRadius: 8
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Rental Nights' } }, y: { title: { display: true, text: 'ADR ($)' }, ticks: { callback: v => '$' + v.toLocaleString() } } }, plugins: { legend: { display: false } } }
        });
      }
    }

    // Chat
    function toggleChat() {
      const panel = document.getElementById('chatPanel');
      const fab = document.getElementById('chatFab');
      panel.classList.toggle('open');
      fab.classList.toggle('open');
      fab.textContent = panel.classList.contains('open') ? '‚úï' : 'üí¨';
    }

    async function sendChat() {
      const input = document.getElementById('chatInput');
      const question = input.value.trim();
      if (!question) return;
      
      const messagesEl = document.getElementById('chatMessages');
      messagesEl.innerHTML += `<div class="chat-message user"><div class="bubble">${question}</div></div>`;
      input.value = '';
      messagesEl.innerHTML += `<div class="chat-message ai" id="typing"><div class="bubble" style="opacity:0.5">Thinking...</div></div>`;
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      try {
        const res = await fetch('/api/ai/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question }) });
        const data = await res.json();
        document.getElementById('typing')?.remove();
        messagesEl.innerHTML += `<div class="chat-message ai"><div class="bubble">${data.error || data.answer.replace(/\n/g, '<br>')}</div></div>`;
      } catch (err) {
        document.getElementById('typing')?.remove();
        messagesEl.innerHTML += `<div class="chat-message ai"><div class="bubble">Error: ${err.message}</div></div>`;
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // Upload
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');
    uploadZone.onclick = () => fileInput.click();
    uploadZone.ondragover = e => { e.preventDefault(); uploadZone.style.borderColor = 'var(--accent)'; };
    uploadZone.ondragleave = () => uploadZone.style.borderColor = '';
    uploadZone.ondrop = e => { e.preventDefault(); uploadZone.style.borderColor = ''; if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]); };
    fileInput.onchange = () => { if (fileInput.files.length) handleUpload(fileInput.files[0]); };

    async function handleUpload(file) {
      if (!file.name.toLowerCase().match(/\.xlsx?$/)) { 
        uploadStatus.className = 'upload-status error'; 
        uploadStatus.textContent = 'Please upload an Excel file (.xlsx)'; 
        return; 
      }
      uploadStatus.className = 'upload-status loading'; 
      uploadStatus.textContent = 'Processing Excel file...';
      document.getElementById('uploadResults').innerHTML = '';
      
      const formData = new FormData(); 
      formData.append('file', file);
      
      try {
        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        const data = await res.json();
        
        if (data.success) { 
          uploadStatus.className = 'upload-status success'; 
          uploadStatus.textContent = `‚úì ${data.message}`;
          
          if (data.months && data.months.length > 0) {
            let html = '<table class="data-table" style="font-size:0.75rem;"><thead><tr><th>Month</th><th class="r">Owner</th><th class="r">Guest</th><th class="r">Rental</th><th class="r">Vacant</th><th class="r">Revenue</th><th class="r">Expenses</th></tr></thead><tbody>';
            for (const m of data.months) {
              html += `<tr><td>${monthNames[m.month]} ${m.year}</td><td class="r">${m.owner}</td><td class="r">${m.guest}</td><td class="r">${m.rental}</td><td class="r">${m.vacant}</td><td class="r">${fmt(m.revenue)}</td><td class="r">${fmt(m.expenses)}</td></tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('uploadResults').innerHTML = html;
          }
          await loadInitialData(); 
        }
        else { uploadStatus.className = 'upload-status error'; uploadStatus.textContent = data.error || 'Failed'; }
      } catch (err) { uploadStatus.className = 'upload-status error'; uploadStatus.textContent = 'Upload failed: ' + err.message; }
      fileInput.value = '';
    }

    async function clearAllData() {
      if (!confirm('Delete ALL data? This cannot be undone.')) return;
      if (!confirm('Really delete everything?')) return;
      try {
        const res = await fetch('/api/statements/all', { method: 'DELETE' });
        const data = await res.json();
        if (data.success) { alert('All data cleared. Upload your Excel file.'); await loadInitialData(); }
        else { alert('Failed: ' + data.error); }
      } catch (err) { alert('Error: ' + err.message); }
    }

    checkAuth();
  </script>
</body>
</html>
